# Shai-Hulud 2025 Campaign - Video Pipeline Makefile
# Usage: make <target>

# Configuration
CAMPAIGN_DIR := $(shell pwd)
SCRIPTS_DIR := $(CAMPAIGN_DIR)/scripts
PYTHON := python3

# Default target
.PHONY: all
all: help

# Help target
.PHONY: help
help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘       Shai-Hulud 2025 Campaign - Video Pipeline Makefile        â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘  Setup:                                                          â•‘"
	@echo "â•‘    make install      - Install Python dependencies               â•‘"
	@echo "â•‘    make setup-env    - Create .env file from template            â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Pipeline Steps (run in order):                                  â•‘"
	@echo "â•‘    make outline      - Generate video outline from threat doc    â•‘"
	@echo "â•‘    make script       - Generate long-form script from outline    â•‘"
	@echo "â•‘    make shorts       - Generate YouTube Shorts scripts           â•‘"
	@echo "â•‘    make shotlist     - Generate Sora 2 shotlist from script      â•‘"
	@echo "â•‘    make audio        - Generate ElevenLabs voiceover             â•‘"
	@echo "â•‘    make sora         - Generate Sora 2 video clips               â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Workflow:                                                       â•‘"
	@echo "â•‘    make content      - Run outline â†’ script â†’ shorts â†’ shotlist  â•‘"
	@echo "â•‘    make media        - Run audio â†’ sora                          â•‘"
	@echo "â•‘    make pipeline     - Run full pipeline (all steps)             â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Testing:                                                        â•‘"
	@echo "â•‘    make dry-run      - Preview all steps without API calls       â•‘"
	@echo "â•‘    make simulate     - Run full pipeline with fake adapters      â•‘"
	@echo "â•‘    make test         - Run unit tests                            â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Utilities:                                                      â•‘"
	@echo "â•‘    make clean        - Remove generated files                    â•‘"
	@echo "â•‘    make status       - Show pipeline status                      â•‘"
	@echo "â•‘    make validate     - Check configuration                       â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Setup targets
.PHONY: install
install:
	@echo "ğŸ“¦ Installing Python dependencies..."
	pip install -r requirements.txt
	@echo "âœ… Dependencies installed"

.PHONY: setup-env
setup-env:
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "âœ… Created .env from template"; \
		echo "âš ï¸  Edit .env and add your API keys"; \
	else \
		echo "âš ï¸  .env already exists, skipping"; \
	fi

# Validation
.PHONY: validate
validate:
	@echo "ğŸ” Validating configuration..."
	@$(PYTHON) -c "from scripts.config import get_config; c = get_config(); errors = c.validate(); print('\n'.join(errors) if errors else 'âœ… Configuration valid')"

# Step 1: Generate outline from threat doc
.PHONY: outline
outline:
	@echo "ğŸ“‹ Step 1: Generating video outline..."
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_outline

# Step 2: Generate long-form script from outline
.PHONY: script
script:
	@echo "ğŸ“ Step 2: Generating long-form script..."
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_script

# Step 3: Generate YouTube Shorts scripts
.PHONY: shorts
shorts:
	@echo "ğŸ¬ Step 3: Generating Shorts scripts..."
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_shorts

# Step 4: Generate Sora 2 shotlist
.PHONY: shotlist
shotlist:
	@echo "ğŸ¥ Step 4: Generating Sora 2 shotlist..."
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_shotlist

# Step 5: Generate ElevenLabs voiceover
.PHONY: audio
audio:
	@echo "ğŸ™ï¸ Step 5: Generating ElevenLabs voiceover..."
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_audio

# Step 6: Generate Sora 2 video clips
.PHONY: sora
sora:
	@echo "ğŸ¬ Step 6: Generating Sora 2 video clips..."
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_sora_clips

# Workflow targets
.PHONY: content
content: outline script shorts shotlist
	@echo ""
	@echo "âœ… Content generation complete!"
	@echo "   Generated files in data/processed/"

.PHONY: media
media: audio sora
	@echo ""
	@echo "âœ… Media generation complete!"
	@echo "   Audio: audio/voiceover.mp3"
	@echo "   Video: video/*.mp4"

.PHONY: pipeline
pipeline: content media
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "âœ… Full pipeline complete!"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Import audio/voiceover.mp3 into your editor"
	@echo "  2. Import video/*.mp4 clips as B-roll"
	@echo "  3. Sync audio with video using B-roll markers"
	@echo "  4. Add titles, transitions, and effects"
	@echo "  5. Export final video"

# Dry run (test without API calls)
.PHONY: dry-run
dry-run:
	@echo "ğŸ§ª DRY RUN - Testing pipeline without API calls..."
	@echo ""
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_outline --dry-run
	@echo ""
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_script --dry-run
	@echo ""
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_shorts --dry-run
	@echo ""
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_shotlist --dry-run
	@echo ""
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_audio --dry-run
	@echo ""
	cd $(CAMPAIGN_DIR) && $(PYTHON) -m scripts.generate_sora_clips --dry-run
	@echo ""
	@echo "âœ… Dry run complete - no API calls made"

# Simulation mode (full pipeline with fake adapters)
.PHONY: simulate
simulate:
	@echo "ğŸ¤– SIMULATION - Running full pipeline with fake adapters..."
	@echo ""
	cd $(CAMPAIGN_DIR) && export PYTHONPATH=$(CAMPAIGN_DIR)/scripts && $(PYTHON) -m scripts.generate_outline --simulate
	@echo ""
	cd $(CAMPAIGN_DIR) && export PYTHONPATH=$(CAMPAIGN_DIR)/scripts && $(PYTHON) -m scripts.generate_script --simulate
	@echo ""
	cd $(CAMPAIGN_DIR) && export PYTHONPATH=$(CAMPAIGN_DIR)/scripts && $(PYTHON) -m scripts.generate_shorts --simulate
	@echo ""
	cd $(CAMPAIGN_DIR) && export PYTHONPATH=$(CAMPAIGN_DIR)/scripts && $(PYTHON) -m scripts.generate_shotlist --simulate
	@echo ""
	cd $(CAMPAIGN_DIR) && export PYTHONPATH=$(CAMPAIGN_DIR)/scripts && $(PYTHON) -m scripts.generate_audio --simulate
	@echo ""
	cd $(CAMPAIGN_DIR) && export PYTHONPATH=$(CAMPAIGN_DIR)/scripts && $(PYTHON) -m scripts.generate_sora_clips --simulate
	@echo ""
	@echo "âœ… Simulation complete - Check data/processed and audio/ for fake content"

# Unit tests
.PHONY: test
test:
	@echo "ğŸ§ª Running unit tests..."
	export PYTHONPATH=$PYTHONPATH:$(CAMPAIGN_DIR)/scripts && $(PYTHON) -m pytest tests/

# Clean generated files
.PHONY: clean
clean:
	@echo "ğŸ§¹ Cleaning generated files..."
	rm -f data/processed/outline.json
	rm -f data/processed/script-longform.md
	rm -f data/processed/shorts-scripts.md
	rm -f data/processed/shotlist.json
	rm -f audio/voiceover.mp3
	rm -f video/*.mp4
	@echo "âœ… Clean complete"

# Show pipeline status
.PHONY: status
status:
	@echo "ğŸ“Š Pipeline Status: Shai-Hulud 2025"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“„ Source Documents:"
	@[ -f docs/shai-hulud-paradigm.md ] && echo "  âœ… docs/shai-hulud-paradigm.md" || echo "  âŒ docs/shai-hulud-paradigm.md (MISSING)"
	@[ -f data/raw/intel-links.md ] && echo "  âœ… data/raw/intel-links.md" || echo "  âš ï¸  data/raw/intel-links.md"
	@echo ""
	@echo "ğŸ”§ Configuration:"
	@[ -f .env ] && echo "  âœ… .env file exists" || echo "  âŒ .env file missing (run: make setup-env)"
	@echo ""
	@echo "ğŸ“Š Generated Content:"
	@[ -f data/processed/outline.json ] && echo "  âœ… outline.json" || echo "  â¬œ outline.json (make outline)"
	@[ -f data/processed/script-longform.md ] && echo "  âœ… script-longform.md" || echo "  â¬œ script-longform.md (make script)"
	@[ -f data/processed/shorts-scripts.md ] && echo "  âœ… shorts-scripts.md" || echo "  â¬œ shorts-scripts.md (make shorts)"
	@[ -f data/processed/shotlist.json ] && echo "  âœ… shotlist.json" || echo "  â¬œ shotlist.json (make shotlist)"
	@echo ""
	@echo "ğŸµ Audio:"
	@[ -f audio/voiceover.mp3 ] && echo "  âœ… voiceover.mp3" || echo "  â¬œ voiceover.mp3 (make audio)"
	@echo ""
	@echo "ğŸ¬ Video Clips:"
	@ls -1 video/*.mp4 2>/dev/null | wc -l | xargs -I {} echo "  {} clips in video/"
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"